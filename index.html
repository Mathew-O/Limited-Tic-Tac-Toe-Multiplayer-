<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limited Tic-Tac-Toe - Multiplayer</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Firebase Configuration
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyDIl13YItSZQgDjqX_mVmdqIQVoSUdPtCw",
          authDomain: "limited-tic-tac-toe-9aab4.firebaseapp.com",
          databaseURL: "https://limited-tic-tac-toe-9aab4-default-rtdb.firebaseio.com",
          projectId: "limited-tic-tac-toe-9aab4",
          storageBucket: "limited-tic-tac-toe-9aab4.firebasestorage.app",
          messagingSenderId: "873527672088",
          appId: "1:873527672088:web:7342b3681bfe8eea25326d",
          measurementId: "G-C8QRVZ7HTL"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }

        // Lucide Icons as SVG components
        const RotateCcw = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path d="M8 16H3v5"/>
          </svg>
        );

        const Users = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        );

        const Search = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
        );

        const Copy = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
          </svg>
        );

        const Check = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        );

        function LimitedTicTacToe() {
          // Game state
          const [board, setBoard] = useState(Array(9).fill(null));
          const [moveHistory, setMoveHistory] = useState({ X: [], O: [] });
          const [currentPlayer, setCurrentPlayer] = useState('X');
          const [winner, setWinner] = useState(null);
          const [gameOver, setGameOver] = useState(false);
          
          // Multiplayer state
          const [gameMode, setGameMode] = useState('menu');
          const [roomCode, setRoomCode] = useState('');
          const [inputCode, setInputCode] = useState('');
          const [playerRole, setPlayerRole] = useState(null);
          const [opponentConnected, setOpponentConnected] = useState(false);
          const [copied, setCopied] = useState(false);
          const [searching, setSearching] = useState(false);
          const [firebaseReady, setFirebaseReady] = useState(true);
          const [error, setError] = useState('');
          const [loading, setLoading] = useState(false);

          const winningCombos = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
          ];

          const checkWinner = (currentBoard) => {
            for (let combo of winningCombos) {
              const [a, b, c] = combo;
              if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
                return currentBoard[a];
              }
            }
            return null;
          };

          const generateRoomCode = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
          };

          const createRoom = async () => {
            if (!firebaseReady) {
              setError("Firebase not ready. Please refresh the page.");
              return;
            }
            
            const code = generateRoomCode();
            const db = firebase.database();
            
            console.log("Creating room with code:", code);
            
            try {
              await db.ref(`rooms/${code}`).set({
                board: Array(9).fill(null),
                moveHistory: { X: [], O: [] },
                currentPlayer: 'X',
                winner: null,
                gameOver: false,
                host: true,
                opponent: false,
                createdAt: Date.now()
              });
              
              console.log("Room created successfully");
              
              setRoomCode(code);
              setPlayerRole('X');
              setGameMode('create');
              setError('');
              listenToRoom(code);
            } catch (err) {
              setError("Failed to create room: " + err.message);
              console.error("Create room error:", err);
            }
          };

          const joinRoom = async () => {
            if (!firebaseReady || !inputCode) {
              setError("Please enter a room code");
              return;
            }
            
            setLoading(true);
            const db = firebase.database();
            const code = inputCode.toUpperCase();
            
            console.log("Attempting to join room:", code);
            
            try {
              const snapshot = await db.ref(`rooms/${code}`).once('value');
              
              console.log("Room snapshot:", snapshot.val());
              
              if (!snapshot.exists()) {
                setError("Room not found. Make sure the code is correct.");
                setLoading(false);
                return;
              }
              
              const roomData = snapshot.val();
              
              if (roomData.opponent) {
                setError("Room is full. Only 2 players allowed.");
                setLoading(false);
                return;
              }
              
              await db.ref(`rooms/${code}/opponent`).set(true);
              
              // Set initial state from room data
              setBoard(roomData.board || Array(9).fill(null));
              setMoveHistory(roomData.moveHistory || { X: [], O: [] });
              setCurrentPlayer(roomData.currentPlayer || 'X');
              setWinner(roomData.winner || null);
              setGameOver(roomData.gameOver || false);
              
              setRoomCode(code);
              setPlayerRole('O');
              setOpponentConnected(true);
              setGameMode('playing');
              setError('');
              setLoading(false);
              listenToRoom(code);
            } catch (err) {
              setError("Failed to join room: " + err.message);
              setLoading(false);
              console.error("Join room error:", err);
            }
          };

          const listenToRoom = (code) => {
            const db = firebase.database();
            const roomRef = db.ref(`rooms/${code}`);
            
            roomRef.on('value', (snapshot) => {
              const data = snapshot.val();
              
              if (data) {
                setBoard(data.board || Array(9).fill(null));
                setMoveHistory(data.moveHistory || { X: [], O: [] });
                setCurrentPlayer(data.currentPlayer || 'X');
                setWinner(data.winner || null);
                setGameOver(data.gameOver || false);
                
                if (data.opponent && gameMode === 'create') {
                  setOpponentConnected(true);
                  setGameMode('playing');
                }
              }
            });
          };

          const startMatchmaking = async () => {
            if (!firebaseReady) return;
            
            setSearching(true);
            setGameMode('matchmaking');
            const db = firebase.database();
            const queueRef = db.ref('queue');
            
            try {
              const snapshot = await queueRef.once('value');
              const queue = snapshot.val() || {};
              const waitingPlayers = Object.keys(queue);
              
              if (waitingPlayers.length > 0) {
                const opponentId = waitingPlayers[0];
                const code = queue[opponentId].roomCode;
                
                await queueRef.child(opponentId).remove();
                await db.ref(`rooms/${code}/opponent`).set(true);
                
                setRoomCode(code);
                setPlayerRole('O');
                setOpponentConnected(true);
                setGameMode('playing');
                setSearching(false);
                listenToRoom(code);
              } else {
                const code = generateRoomCode();
                const playerId = Date.now().toString();
                
                await db.ref(`rooms/${code}`).set({
                  board: Array(9).fill(null),
                  moveHistory: { X: [], O: [] },
                  currentPlayer: 'X',
                  winner: null,
                  gameOver: false,
                  host: true,
                  opponent: false,
                  createdAt: Date.now()
                });
                
                await queueRef.child(playerId).set({
                  roomCode: code,
                  timestamp: Date.now()
                });
                
                setRoomCode(code);
                setPlayerRole('X');
                
                const roomRef = db.ref(`rooms/${code}`);
                roomRef.on('value', (snapshot) => {
                  const data = snapshot.val();
                  if (data && data.opponent) {
                    queueRef.child(playerId).remove();
                    setOpponentConnected(true);
                    setGameMode('playing');
                    setSearching(false);
                    listenToRoom(code);
                  }
                });
              }
            } catch (err) {
              setError("Matchmaking failed");
              setSearching(false);
              console.error(err);
            }
          };

          const cancelMatchmaking = async () => {
            if (!firebaseReady) return;
            
            const db = firebase.database();
            const queueRef = db.ref('queue');
            
            const snapshot = await queueRef.once('value');
            const queue = snapshot.val() || {};
            
            for (let playerId in queue) {
              if (queue[playerId].roomCode === roomCode) {
                await queueRef.child(playerId).remove();
                break;
              }
            }
            
            setSearching(false);
            setGameMode('menu');
            setRoomCode('');
          };

          const handleClick = async (index) => {
            if (!board || board[index] || gameOver) return;
            
            if (gameMode === 'playing' && currentPlayer !== playerRole) return;

            const newBoard = [...board];
            const newHistory = { ...moveHistory };

            newBoard[index] = currentPlayer;
            newHistory[currentPlayer] = [...(newHistory[currentPlayer] || []), index];

            if (newHistory[currentPlayer].length > 3) {
              const oldestMove = newHistory[currentPlayer].shift();
              newBoard[oldestMove] = null;
            }

            const gameWinner = checkWinner(newBoard);
            const newGameOver = !!gameWinner;
            const nextPlayer = currentPlayer === 'X' ? 'O' : 'X';

            if (gameMode === 'playing' && firebaseReady) {
              const db = firebase.database();
              await db.ref(`rooms/${roomCode}`).update({
                board: newBoard,
                moveHistory: newHistory,
                currentPlayer: nextPlayer,
                winner: gameWinner,
                gameOver: newGameOver
              });
            } else {
              setBoard(newBoard);
              setMoveHistory(newHistory);
              setWinner(gameWinner);
              setGameOver(newGameOver);
              setCurrentPlayer(nextPlayer);
            }
          };

          const resetGame = async () => {
            if (gameMode === 'playing' && firebaseReady) {
              const db = firebase.database();
              await db.ref(`rooms/${roomCode}`).update({
                board: Array(9).fill(null),
                moveHistory: { X: [], O: [] },
                currentPlayer: 'X',
                winner: null,
                gameOver: false
              });
            } else {
              setBoard(Array(9).fill(null));
              setMoveHistory({ X: [], O: [] });
              setCurrentPlayer('X');
              setWinner(null);
              setGameOver(false);
            }
          };

          const leaveRoom = async () => {
            if (firebaseReady && roomCode) {
              const db = firebase.database();
              await db.ref(`rooms/${roomCode}`).remove();
            }
            
            setGameMode('menu');
            setRoomCode('');
            setPlayerRole(null);
            setOpponentConnected(false);
            setBoard(Array(9).fill(null));
            setMoveHistory({ X: [], O: [] });
            setCurrentPlayer('X');
            setWinner(null);
            setGameOver(false);
            setError('');
          };

          const getAge = (index) => {
            if (!board || !board[index]) return null;
            
            const player = board[index];
            if (!moveHistory || !moveHistory[player]) return null;
            
            const position = moveHistory[player].indexOf(index);
            return moveHistory[player].length - position;
          };

          const copyRoomCode = () => {
            navigator.clipboard.writeText(roomCode);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          };

          if (gameMode === 'menu') {
            return (
              <div className="min-h-screen bg-yellow-300 flex items-center justify-center p-8">
                <div className="bg-white border-8 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] max-w-md w-full">
                  <h1 className="text-5xl font-black text-center mb-2 uppercase tracking-tight">
                    Limited
                  </h1>
                  <h2 className="text-4xl font-black text-center mb-8 uppercase tracking-tight">
                    Tic-Tac-Toe
                  </h2>

                  {error && (
                    <div className="bg-red-400 border-4 border-black p-3 mb-4">
                      <p className="font-bold text-sm">{error}</p>
                    </div>
                  )}

                  <div className="space-y-4">
                    <button
                      onClick={() => setGameMode('local')}
                      className="w-full bg-pink-400 border-4 border-black p-4 font-bold text-xl uppercase
                                 shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                                 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all"
                    >
                      Local Game
                    </button>

                    <button
                      onClick={createRoom}
                      disabled={!firebaseReady}
                      className="w-full bg-cyan-400 border-4 border-black p-4 font-bold text-xl uppercase
                                 shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                                 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2
                                 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Users size={24} />
                      Create Room
                    </button>

                    <button
                      onClick={() => setGameMode('join')}
                      disabled={!firebaseReady}
                      className="w-full bg-lime-400 border-4 border-black p-4 font-bold text-xl uppercase
                                 shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                                 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all
                                 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Join Room
                    </button>

                    <button
                      onClick={startMatchmaking}
                      disabled={!firebaseReady}
                      className="w-full bg-orange-400 border-4 border-black p-4 font-bold text-xl uppercase
                                 shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                                 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2
                                 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Search size={24} />
                      Find Match
                    </button>
                  </div>

                  <div className="mt-6 bg-purple-400 border-4 border-black p-3">
                    <p className="text-sm font-bold">
                      HOW TO PLAY: Each player can only have 3 pieces on the board. 
                      When you place a 4th piece, your oldest piece disappears!
                    </p>
                  </div>
                </div>
              </div>
            );
          }

          if (gameMode === 'join') {
            return (
              <div className="min-h-screen bg-yellow-300 flex items-center justify-center p-8">
                <div className="bg-white border-8 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] max-w-md w-full">
                  <h2 className="text-3xl font-black text-center mb-6 uppercase">
                    Join Room
                  </h2>

                  {error && (
                    <div className="bg-red-400 border-4 border-black p-3 mb-4">
                      <p className="font-bold text-sm">{error}</p>
                    </div>
                  )}

                  <input
                    type="text"
                    placeholder="Enter Room Code"
                    value={inputCode}
                    onChange={(e) => setInputCode(e.target.value.toUpperCase())}
                    maxLength={6}
                    className="w-full bg-white border-4 border-black p-4 font-bold text-2xl uppercase text-center mb-4
                               focus:outline-none focus:ring-4 focus:ring-cyan-400"
                  />

                  <button
                    onClick={joinRoom}
                    disabled={loading}
                    className="w-full bg-lime-400 border-4 border-black p-4 font-bold text-xl uppercase mb-4
                               shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all
                               disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? 'Joining...' : 'Join'}
                  </button>

                  <button
                    onClick={() => { setGameMode('menu'); setError(''); setInputCode(''); }}
                    className="w-full bg-gray-300 border-4 border-black p-3 font-bold uppercase
                               shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all"
                  >
                    Back
                  </button>
                </div>
              </div>
            );
          }

          if (gameMode === 'create') {
            return (
              <div className="min-h-screen bg-yellow-300 flex items-center justify-center p-8">
                <div className="bg-white border-8 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] max-w-md w-full">
                  <h2 className="text-3xl font-black text-center mb-6 uppercase">
                    Waiting for Opponent
                  </h2>

                  <div className="bg-cyan-400 border-4 border-black p-6 mb-6">
                    <p className="text-sm font-bold text-center mb-2">ROOM CODE</p>
                    <div className="flex items-center justify-center gap-2">
                      <p className="text-4xl font-black text-center">{roomCode}</p>
                      <button
                        onClick={copyRoomCode}
                        className="bg-white border-2 border-black p-2 hover:bg-gray-100 transition-all"
                      >
                        {copied ? <Check size={20} /> : <Copy size={20} />}
                      </button>
                    </div>
                    <p className="text-xs text-center mt-2">Share this code with your friend!</p>
                  </div>

                  <div className="bg-purple-400 border-4 border-black p-4 mb-6">
                    <p className="text-center font-bold animate-pulse">
                      Waiting for opponent to join...
                    </p>
                  </div>

                  <button
                    onClick={leaveRoom}
                    className="w-full bg-gray-300 border-4 border-black p-3 font-bold uppercase
                               shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            );
          }

          if (gameMode === 'matchmaking' && searching) {
            return (
              <div className="min-h-screen bg-yellow-300 flex items-center justify-center p-8">
                <div className="bg-white border-8 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] max-w-md w-full">
                  <h2 className="text-3xl font-black text-center mb-6 uppercase">
                    Finding Match
                  </h2>

                  <div className="bg-orange-400 border-4 border-black p-6 mb-6">
                    <div className="flex justify-center mb-4">
                      <Search size={64} className="animate-bounce" />
                    </div>
                    <p className="text-center font-bold text-lg animate-pulse">
                      Searching for opponent...
                    </p>
                  </div>

                  <button
                    onClick={cancelMatchmaking}
                    className="w-full bg-gray-300 border-4 border-black p-3 font-bold uppercase
                               shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-yellow-300 flex items-center justify-center p-8">
              <div className="bg-white border-8 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] max-w-md w-full">
                <h1 className="text-5xl font-black text-center mb-2 uppercase tracking-tight">
                  Limited
                </h1>
                <h2 className="text-4xl font-black text-center mb-6 uppercase tracking-tight">
                  Tic-Tac-Toe
                </h2>

                {gameMode === 'playing' && (
                  <div className="bg-pink-400 border-4 border-black p-3 mb-4">
                    <p className="text-sm font-bold text-center">
                      You are: <span className="text-2xl">{playerRole}</span>
                      {roomCode && ` | Room: ${roomCode}`}
                    </p>
                  </div>
                )}
                
                <div className="bg-cyan-400 border-4 border-black p-4 mb-6">
                  <p className="font-bold text-lg text-center">
                    {gameOver 
                      ? `${winner} WINS!` 
                      : gameMode === 'playing' && currentPlayer !== playerRole
                        ? "Opponent's Turn"
                        : `Player ${currentPlayer}'s Turn`}
                  </p>
                  <p className="text-sm text-center mt-1">
                    Only 3 pieces at a time!
                  </p>
                </div>

                <div className="grid grid-cols-3 gap-3 mb-6">
                  {board && board.map((cell, index) => {
                    const age = getAge(index);
                    const isMyTurn = gameMode === 'local' || currentPlayer === playerRole;
                    
                    return (
                      <button
                        key={index}
                        onClick={() => handleClick(index)}
                        className={`
                          h-24 border-4 border-black font-black text-4xl
                          transition-all hover:translate-x-1 hover:translate-y-1
                          hover:shadow-none active:translate-x-2 active:translate-y-2
                          ${cell === 'X' ? 'bg-pink-400' : cell === 'O' ? 'bg-lime-400' : 'bg-white'}
                          ${!cell && !gameOver && isMyTurn ? 'cursor-pointer shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]' : 'cursor-default'}
                          ${!cell && !gameOver && !isMyTurn ? 'opacity-50' : ''}
                        `}
                        disabled={!!cell || gameOver || (gameMode === 'playing' && currentPlayer !== playerRole)}
                      >
                        <div className="relative">
                          {cell}
                          {age && (
                            <span className="absolute -top-1 -right-1 text-xs bg-black text-white px-1.5 py-0.5 rounded-full">
                              {age}
                            </span>
                          )}
                        </div>
                      </button>
                    );
                  })}
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={resetGame}
                    className="flex-1 bg-orange-400 border-4 border-black p-4 font-bold text-xl uppercase
                               shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2"
                  >
                    <RotateCcw size={24} />
                    New
                  </button>

                  <button
                    onClick={leaveRoom}
                    className="flex-1 bg-gray-300 border-4 border-black p-4 font-bold text-xl uppercase
                               shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:translate-y-1
                               hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all"
                  >
                    {gameMode === 'playing' ? 'Leave' : 'Menu'}
                  </button>
                </div>

                <div className="mt-6 bg-purple-400 border-4 border-black p-3">
                  <p className="text-sm font-bold">
                    HOW TO PLAY: Each player can only have 3 pieces on the board. 
                    When you place a 4th piece, your oldest piece disappears!
                  </p>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<LimitedTicTacToe />, document.getElementById('root'));
    </script>
</body>
</html>
